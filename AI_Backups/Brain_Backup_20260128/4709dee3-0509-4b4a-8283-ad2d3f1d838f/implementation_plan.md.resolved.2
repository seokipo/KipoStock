# 세금 데이터 수정 및 정렬 기능 구현 계획 (v2)

사용자가 제공한 예제 이미지를 분석하여 세금 관련 필드명을 확인했습니다. 이를 바탕으로 세금 표시 문제를 해결하고, 출력 리스트를 조건식 이름 기준 오름차순으로 정렬합니다.

## 변경 제안 내용

### [chat_command.py](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py)

#### [MODIFY] [today](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py#233-323) 메서드

1.  **세금 데이터 수집 보강:** 
    - 예제 이미지에서 확인된 `tdy_trde_cmsn` (수수료)와 `tdy_trde_tax` (세금) 필드를 합산하여 표시하도록 수정합니다.
    - 기존의 다양한 필드명(`comm_sum_tax`, `tax_amt` 등)에 대한 대응도 유지하면서, 새로운 필드를 우선적으로 체크합니다.

2.  **정렬 기능 추가:**
    - `diary_list`를 순회하여 `display_rows`를 만들기 전에, `cond_mapping`에서 조회된 조건식 이름을 기준으로 리스트를 정렬합니다.
    - 정렬 기준: `cond_mapping.get(code, "직접매매")` (오름차순).

```python
# [수정 상세]
# 1. 정렬
diary_list.sort(key=lambda x: cond_mapping.get(x['stk_cd'].replace('A', ''), "직접매매"))

# 2. 세금 계산 (합산 방식)
cmsn = float(item.get('tdy_trde_cmsn') or item.get('comm_amt') or item.get('tot_comm_amt') or 0)
tax_val = float(item.get('tdy_trde_tax') or item.get('tax_amt') or item.get('tot_trde_tax') or 0)
tax = int(cmsn + tax_val)
if tax == 0: # 백업 로직 (기타 필드 체크)
    tax = int(float(item.get('comm_sum_tax') or item.get('payout_tax') or 0))
```

## 검증 계획

### 수동 검증
- 코드 리뷰를 통해 `tdy_trde_cmsn`과 `tdy_trde_tax`가 제대로 합산되는지 확인합니다.
- `diary_list.sort`가 루프 시작 전에 적절히 위치했는지 확인합니다.
- 사용자에게 [today](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py#233-323) 명령어를 실행하여 다음을 확인 요청:
    - "세금" 항목에 숫자가 제대로 표시되는지.
    - 리스트 상단부터 조건식 이름(예: [직접매매], [신고가-]) 순서대로 잘 정렬되는지.
