# 세금 데이터 및 매도 정보 수정 계획 (v5 - 병합 로직 강화)

매도 수량, 매도 금액, 손익 금액이 0으로 나오는 문제를 해결하기 위해 [ka10077](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/acc_diary.py#60-104) 상세 API의 데이터를 공격적으로 활용하여 [ka10170](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/acc_diary.py#9-58)의 빈틈을 메웁니다.

## 변경 제안 내용

### [chat_command.py](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py)

#### [MODIFY] [today](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py#233-330) 메서드
1.  **상세 데이터 우선 순위**:
    - [ka10077](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/acc_diary.py#60-104)에서 조회된 `cntr_qty`(매도수량), `cntr_pric`(매도가), `tdy_sel_pl`(손익) 등을 우선적으로 사용합니다.
    - [ka10170](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/acc_diary.py#9-58)의 데이터는 종목 리스트를 확보하는 용도 및 보조 데이터로 활용합니다.
2.  **필드 매핑 보강**:
    - [ka10170](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/acc_diary.py#9-58)에서도 `th_sel_qty`, `tot_sel_qty` 등 다양한 매도 관련 필드를 체크하도록 수정합니다.
3.  **손익 계산 로직**:
    - `pnl`이 0일 경우 `매도금액 - 매입금액 - 세금` 공식을 사용하여 수동 계산하는 폴백 로직을 강화합니다.

## 검증 계획

### 수동 검증
- [today](file:///d:/Work/Python/AutoBuy/KipoBuy4.2/chat_command.py#233-330) 명령어 실행 시:
    - **매도수량** 및 **매도금액**이 정상 수치로 나오는지 확인.
    - **손익금액**이 수익률에 맞게 계산되어 나오는지 확인.
- 수정 사항 반영 후 EXE 빌드 및 최종 확인.
