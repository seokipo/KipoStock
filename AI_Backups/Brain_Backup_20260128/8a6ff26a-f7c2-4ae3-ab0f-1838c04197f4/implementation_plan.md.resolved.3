# 구현 계획 - 조건식 확장 & 동적 설정 & 로컬 매수 시간

## 목표 설명
1. **조건식 선택 확장**: GUI에서 조건식을 0~19번(총 20개)까지 선택할 수 있도록 개선합니다.
2. **동적 설정 반영**: 프로그램 실행 중에도 설정(종목수, 익절, 조건식 등) 변경 시 즉시 반영되도록 합니다.
3. **Today 매수 시간 (로컬 트래킹)**: API 데이터에 의존하지 않고, 프로그램이 매수 체결 시점을 직접 기록하여 [today](file:///d:/Work/Python/AutoBuy/KipoStockNow/chat_command.py#233-356) 명령어 출력 시 표시합니다.

## 사용자 검토 필요
> [!IMPORTANT]
> 매수 시간은 `daily_buy_times.json` 파일에 로컬로 저장됩니다. 프로그램이 실행되지 않았던 시간(수동 매수 등)에 대한 기록은 남지 않을 수 있습니다.

## 변경 제안

### 1. 조건식 선택 UI 확장 (20개)
#### [수정] [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoStockNow/Kipo_GUI_main.py)
- [setup_ui](file:///d:/Work/Python/AutoBuy/KipoStockNow/Kipo_GUI_main.py#331-686): 조건식 버튼 루프를 `range(20)`으로 확장.
- 레이아웃: `QGridLayout`을 사용하여 2행 10열(또는 적절한 그리드)로 배치하여 공간 효율성 확보.
- 동작: 버튼 클릭 시 `worker.schedule_command('update_seq', ...)` 및 `refresh_conditions` 호출.

### 2. 로컬 매수 시간 기록
#### [수정] [check_n_buy_1ju.py](file:///d:/Work/Python/AutoBuy/KipoStockNow/check_n_buy_1ju.py)
- `save_buy_time(code)` 함수 추가:
    - `daily_buy_times.json` 파일을 읽고, 해당 종목의 기록이 없으면 현재 시간(`HH:mm:ss`)을 저장.
    - 날짜가 바뀌면 파일 초기화 로직 포함 (또는 파일명에 날짜 포함 `buy_times_20240123.json`).
- [chk_n_buy](file:///d:/Work/Python/AutoBuy/KipoStockNow/check_n_buy_1ju.py#75-243) 성공 시: `save_buy_time` 호출.

### 3. Today 매수 시간 표시
#### [수정] [chat_command.py](file:///d:/Work/Python/AutoBuy/KipoStockNow/chat_command.py)
- [today](file:///d:/Work/Python/AutoBuy/KipoStockNow/chat_command.py#233-356) 메서드:
    - `daily_buy_times.json` 로드.
    - 출력 포맷을 `[{time}] [{cond}] {name}...` 형식으로 변경.
    - 매핑된 시간이 있으면 표시, 없으면 공란.

### 4. 동적 설정 (조건식 새로고침)
#### [수정] [rt_search.py](file:///d:/Work/Python/AutoBuy/KipoStockNow/rt_search.py)
- `refresh_conditions(token)`: 변경된 설정(`search_seq`)을 다시 읽어 서버에 감시 요청(`CNSRREQ`) 전송.

#### [수정] [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoStockNow/Kipo_GUI_main.py)
- 설정 변경(익절/손절/종목수 등) 시 [settings.json](file:///d:/Work/Python/AutoBuy/KipoStockNow/settings.json) 저장 후, 필요한 경우 메모리 갱신 명령 전달.

## 검증 계획
1. **UI**: 20개 버튼 레이아웃 확인.
2. **매수 시간**: 모의 매수(또는 실제 매수) 발생 시 `daily_buy_times.json` 생성 확인 및 [today](file:///d:/Work/Python/AutoBuy/KipoStockNow/chat_command.py#233-356) 출력 확인.
3. **동적 반영**: START 중 조건식 변경 시 로그 확인.
