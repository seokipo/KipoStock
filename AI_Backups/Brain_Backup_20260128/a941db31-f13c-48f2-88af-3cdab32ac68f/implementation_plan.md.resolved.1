# Implementation Plan - KipoBuy GUI Conversion

This plan outlines the steps to convert the existing console-based KipoBuy application into a modern GUI application using PyQt6, as requested.

## User Review Required
> [!IMPORTANT]
> - I will be using **PyQt6** for the GUI as it is robust and professional. Please ensure you are okay with installing this dependency (`pip install PyQt6`).
> - The current [market_hour.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/market_hour.py) has hardcoded open/close times. I will modify this to read from [settings.json](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/settings.json) so the GUI inputs work effectively.
> - I will create a new entry point file [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/Kipo_GUI_main.py). The original [Kipo_main.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/Kipo_main.py) will remain (mostly) untouched for backup, but you should run the new file.

## Proposed Changes

### 1. GUI Implementation
#### [NEW] [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/Kipo_GUI_main.py)
- **Main Window**: Implement the layout provided in the sketch.
    - **Sidebar**: Settings (Conditions 0-9, Profit/Loss, Max Stocks, Times).
    - **Header**: Title "KipoStock V1.2", Start/Stop/Report buttons.
    - **Log Area**: Central dark/black text area for logs.
    - **Footer**: Command input and Send button.
- **Integration**:
    - Run the asyncio event loop in a separate `QThread` (Worker thread) to prevent freezing the GUI.
    - Redirect `sys.stdout` and capture `tel_send` outputs to emit signals to the GUI Log Area.
    - Connect buttons to [ChatCommand](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/chat_command.py#17-285) methods ([start](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/rt_search.py#115-167), [stop](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/rt_search.py#174-180), [report](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/chat_command.py#192-219)).
    - Connect Settings inputs to update [settings.json](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/settings.json).

### 2. Logic Updates
#### [MODIFY] [market_hour.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/market_hour.py)
- Update [MarketHour](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/market_hour.py#3-60) class to read start/end times from [settings.json](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/settings.json) (or a config object) instead of hardcoded constants.

#### [MODIFY] [tel_send.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/tel_send.py)
- (Optional) Modify `tel_send` to also print to `stdout` so the GUI can capture it easily without deep coupling. (Currently likely uses `requests`).

#### [MODIFY] [chat_command.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/chat_command.py)
- Ensure methods like [start](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/rt_search.py#115-167), [stop](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/rt_search.py#174-180) are thread-safe or can be called from the GUI thread (via signals/slots).

### 3. Special Buy Logic (Conditions 0 & 1)
#### [MODIFY] [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/Kipo_GUI_main.py)
- Add "Special Buy Settings" UI group.
    - Checkbox: Use Special Buy for Cond 0, 1. (Implicitly active if inputs are set?) -> User asked for choice.
    - Options: "Fixed Amount" (Input box) vs "Balance %" (Input box).
- Save/Load these settings to [settings.json](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/settings.json).

#### [MODIFY] [stock_info.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/stock_info.py)
- Update [fn_ka10001](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/stock_info.py#7-58) or add `get_current_price` to return the current price (`now_prc` or similar) alongside mechanism to get stock name.

#### [MODIFY] [rt_search.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/rt_search.py)
- Extract condition index (`seq`) from `CNSR` messages (if available) or track which condition triggered the signal.
- Pass `seq` to [chk_n_buy](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/check_n_buy_1ju.py#74-148).

#### [MODIFY] [check_n_buy_1ju.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/check_n_buy_1ju.py)
- Update [chk_n_buy](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/check_n_buy_1ju.py#74-148) to accept `seq`.
- If `seq` is '0' or '1':
    - Retrieve current price.
    - Calculate `qty` based on settings (Fixed Amount or % of Balance).
    - Ensure `qty` >= 1.
- Else:
    - `qty` = 1.

## Verification Plan

### Automated Tests
- Run [Kipo_GUI_main.py](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/Kipo_GUI_main.py) and verify it launches without errors.

### Manual Verification
- **UI Check**: Verify the layout matches the sketch.
- **Settings**: Change a setting (e.g., target profit), save, and check [settings.json](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/settings.json) to see if it updated.
- **Logging**: Click specific buttons and verify logs appear in the central text area.
- **Start/Stop**: Click Start, see if the bot engages (logs check). Click Stop, see if it stops.
- **Command**: Type [help](file:///d:/Work/Python/AutoBuy/KipoBuy_Gui/chat_command.py#265-272) in the command box and verify the response in the log.
